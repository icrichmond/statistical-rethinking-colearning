---
title: ""
output: github_document
---

## Homework Week 3
```{r, eval = T, include = F}
library(rethinking)
library(dagitty)
data("foxes")
d <- foxes
```

**Question 1:** The first two problems are based on the same data. The data in `data (foxes)` are 116 foxes from 30 different urban groups in England. These fox groups are like street gangs. Group size (`groupsize`) varies from 2 to 8 individuals. Each group maintains its own (almost exclusive) urban territory. Some territories are larger than others. The `area` variable encodes this information. Some territories also have more `avgfood` than others. And food influences the `weight` of each fox, where F is `avgfood`, G is `groupsize`, A is `area`, and W is `weight` . Use the backdoor criterion and estimate the total causal influence of A on F. What effect would increasing the area of a territory have on the amount of food inside it?

```{r draw-dag, echo = F}
dag1 <- dagitty("dag {
                A -> F 
                F -> G -> W 
                F -> W }")
coordinates(dag1) <- list(x = c(F = 1, A = 2, W = 2, G = 3), 
                               y = c(F = 0, A = -1, W = 1, G = 0))
drawdag(dag1)
```

Start off by identifying backdoor pathways and the potential adjustments that need to be made to the model to close backdoor paths:
```{r answer-1 dag}
dag1 <- dagitty("dag {
                A -> F 
                F -> G -> W 
                F -> W }")
adjustmentSets(dag1, exposure = "A", outcome = "F", effect = "total")
```

There are no backdoor pathways of A -> F (as seen in the DAG). So building a model with F as a function of A is sufficient: 
```{r answer-1 model}
# standardize variables 
d$F <- standardize(d$avgfood)
d$A <- standardize(d$area)
# model
m1 <- quap(
  alist(
    F ~ dnorm(mu, sigma),
    mu <- a + bA*A,
    a ~ dnorm(0,0.2),
    bA ~ dlnorm(0,0.5), # area can only be positive so constrain to log normal
    sigma ~ dexp(1) 
  ), data = d
)

precis(m1)
```

```{r answer-1 figure, echo = F}
# posterior predictions 
A_seq <- seq( from= -3 , to=3 , length.out=30 )
mu <- link( m1 , data=list(A=A_seq) )
mu.mean <- apply( mu , 2, mean )
mu.PI <- apply( mu , 2 , PI )
# plot it all
plot( F ~ A , data=d , col=rangi2 )
lines( A_seq , mu.mean , lwd=2 )
shade(mu.PI, A_seq )
```

The model output suggests that increasing the area territory would increase the amount of food available. 



**Question 2:** Now infer both the total and direct causal effects of adding food F to a territory on the weight W of foxes. Which covariates do you need to adjust for in each case? In light of your estimates from this problem and the previous
one, what do you think is going on with these foxes? Feel free to speculate - all that matters is that you justify your speculation.

Total causal effects of F on W: 
```{r answer-2 total-model}
# standardize variables 
d$F <- standardize(d$avgfood)
d$W <- standardize(d$weight)
# model total effects
m2t <- quap(
  alist(
    W ~ dnorm(mu, sigma),
    mu <- a + bF*F,
    a ~ dnorm(0,0.2),
    bF ~ dnorm(0,0.5), 
    sigma ~ dexp(1) 
  ), data = d
)

precis(m2t)
```

```{r answer-2 figure-m2t, echo = F}
# posterior predictions 
A_seq <- seq( from= -3 , to=3 , length.out=30 )
mu <- link( m2t , data=list(A=A_seq) )
mu.mean <- apply( mu , 2, mean )
mu.PI <- apply( mu , 2 , PI )
# plot it all
plot( W ~ F , data=d , col=rangi2 )
lines( A_seq , mu.mean , lwd=2 )
shade(mu.PI, A_seq )
```

Total causal model indicates that there is no relationship between average food and weight of foxes.  

To assess the direct causal effects of food on weight, we need to stratify by group size (G) because it is currently an open backdoor path (pipe). Let's confirm using `dagitty`: 
```{r answer-2 dag}
adjustmentSets(dag1, exposure = "F", outcome = "W", effect = "direct")
```

Add G to the model: 
```{r answer-2 direct-model}
# standardize variables 
d$F <- standardize(d$avgfood)
d$W <- standardize(d$weight)
d$G <- standardize(d$groupsize)

# model total effects
m2d <- quap(
  alist(
    W ~ dnorm(mu, sigma),
    mu <- a + bF*F + bG*G,
    a ~ dnorm(0,0.2),
    bF ~ dnorm(0,0.5),
    bG ~ dnorm(0, 0.5), 
    sigma ~ dexp(1) 
  ), data = d
)

precis(m2d)
```

The direct effect of food on weight is positive. Group size has an equal magnitude of effect in the opposite direction. These two effects cancel each other - which explains why the total effect of food is negligible: direct effect is positive but mediated effect through group size is negative/cancelled out. 

Food influences group size, which mediates the influence of food on weight. More foxes are present when more food is present, so foxes get the same amount of food and their weight does not change.


**Question 3:** Reconsider the Table 2 Fallacy example (from Lecture 6), this time with an unobserved confound U that influences both smoking S and stroke Y. Here’s the modified DAG:

```{r draw-dag-q3, echo = F}
dag2 <- dagitty("dag {
                U [unobserved]
                A -> S -> X -> Y 
                A -> X -> Y
                A -> S -> Y
                U -> S -> Y
                A -> Y
                U -> Y
                 }")
coordinates(dag2) <- list(x = c(A = 1, S = 1, X = 2, U = 2, Y = 3), 
                               y = c(A = 1, S = -1, X = 0, U = -1.2, Y = 0))
drawdag(dag2)
```

First use the backdoor criterion to determine an adjustment set that allows you to estimate the causal effect of X on Y, i.e. P(Y|do(X)). Second explain the proper interpretation of each coefficient implied by the regression model that corresponds to the adjustment set. Which coefficients (slopes) are causal and which are not? There is no need to fit any models. Just think through the implications.

Currently, there are several backdoors open: 

U -> S -> X -> Y  
A -> S -> X -> Y  
A -> X -> Y   

Based on this, I think we should stratify by A to close one set of backdoors. Additionally, stratifying by S could close the backdoor through X, however, it is a collider between A and U and so stratifying by S would open that pathway and create collider bias. So, I would only stratify by A.   

**CORRECTION:** collider bias does not influence our estimate of X-> Y because collider is between A -> S <- U and U does not introduce an arrow into X so we can stratify by both! 

Dagitty confirms that stratifying by A and S is required to estimate the direct effect of X on Y: 

```{r answer-3 dag}
adjustmentSets(dag2, exposure = "X", outcome = "Y", effect = "direct")
```

In terms of which coefficients are causal and which are not: 

X is a causal effect. Other coefficients are now biased by U. Stratifying by S opens collider bias and A and S are not causal effects because they are biased. Need explicit causal models to interpret control coefficients.

**Question 4-OPTIONAL CHALLENGE:** Write a synthetic data simulation for the causal model shown in Problem 3. Be sure to include the unobserved confound in the simulation. Choose any functional relationships that you like—you don’t have to get the epidemiology correct. You just need to honor the causal structure. Then design a regression model to estimate the influence of X on Y and use it on your synthetic data. How large of a sample do you need to reliably estimate P(Y|do(X))? Define “reliably” as you like, but justify your definition.  

```{r answer-4}
N <- 200 

b_AY <- 3 # direct effect of A on Y 
b_AS <- 2 # direct effect of A on S 
b_AX <- 2 # direct effect of A on X 
b_SX <- 2 # direct effect of S on X 
b_SY <- 3 # direct effect of S on Y 
b_XY <- 1 # direct effect of X on Y 
b_U <- 2 # direct effect of U on S and Y 

U <- 2*rbern(N, 0.5) - 1
A <- rnorm(N)
S <- rnorm(N, b_AS*A + b_U*U)
X <- rnorm(N, b_SX*S + b_AX*A)
Y <- rnorm(N, b_AY*A + b_SY*S + b_XY*X + b_U*U)
ds <- data.frame(A=A, S=S, X=X, U=U, Y=Y)

m4 <- quap(
  alist(
    X ~ dnorm(mu, sigma), 
    mu <- a + b_XY*X + b_AY*A + b_SY*S,
    a ~ dnorm(0, 1),
    c(b_XY, b_AY, b_SY) ~ dnorm(0, 1), 
    sigma ~ dexp(1)
  ), data = ds
)

precis(m4)
```


