---
title: "Homework - Week 05"
author: "Isabella C. Richmond"
format: html
---

```{r, include = FALSE}
source('R/packages.R')
```

#### Question 1: The data in data(NWOGrants) are outcomes for scientific funding applications for the Netherlands Organization for Scientific Research (NWO) from 2010–2012 (see van der Lee and Ellemers doi:10.1073/pnas.1510159112). These data have a structure similar to the UCBAdmit data discussed in Chapter 11 and in lecture. There are applications and each has an associated gender (of the lead researcher). But instead of departments, there are disciplines. Draw a DAG for this sample. Then use the backdoor criterion and a binomial GLM to estimate the TOTAL causal effect of gender on grant awards.

```{r, echo=FALSE}
dag <- dagify(
    D ~ G,
    A ~ G + D
)

ggdag(dag) +
    theme_dag()
```

Where G = gender, D = discipline, and A = awards. We assume there are confounds between D and A. To get the total effect of gender, we model awards stratified by gender.

```{r}
data("NWOGrants")

df <- NWOGrants %>%
  mutate(awards = as.integer(awards),
         applications = as.integer(applications),
         discipline = as.integer(discipline),
         gender = as.factor(case_when(gender == 'f' ~ 1,
                            gender == 'm' ~ 2)))

# load prior only model to investigate priors 
tar_load(h05_q1_prior)
m1p<- h05_q1_prior
m1p$prior
plot(m1p)

# get posterior distribution
post <- as_draws_df(m1p)

# transform logit values back to probability
post <- post %>% 
  mutate(p_int = exp(b_Intercept) / (1 + exp(b_Intercept)),
         p_gen = exp(b_gender2) / (1 + exp(b_gender2)))

# look at prior for intercept
ggplot(post, aes(p_int)) +
  geom_density() + 
  theme_classic()

# look at prior for gender
ggplot(post, aes(p_gen)) +
  geom_density() + 
  theme_classic()

```

Now let's investigate the model with the data: 

```{r}

tar_load(h05_q1)
m1<- h05_q1

# diagnostics
plot(m1)

# summary table (logit)
posterior_summary(m1)

# contrast the differences between genders - brms eats levels into the intercept
df_gender <- data.frame(gender = c(1, 2))
# use model to predict values for each gender
# adds draws from (possibly transformed) posterior linear predictors (or "link-level" predictors) to the data.
pred_brms <- add_linpred_draws(df_gender, m1) %>%
  mutate(ppred = exp(.linpred) / (1 + exp(.linpred)))

# plot the effects
ggplot(pred_brms, aes(gender, ppred)) +
    stat_pointinterval() +
    coord_flip() + 
    theme_classic()


# contrast the two genders 
c <- pred_brms %>%
  ungroup() %>%
  select(gender, .linpred, ppred) %>%
  mutate(contrast = ppred - ppred[gender == '2'] ) %>% 
  filter(contrast < 0)

ggplot(c, aes(contrast)) + 
  geom_density() + 
  theme_classic() +
  labs(x = "Contrast (F-M) total")

```

This shows a 20% disadvantage of women... Differs a lot from Richard's answer and I'm not sure why.

#### Question 2: Now estimate the DIRECT causal effect of gender on grant awards. Use the same DAG as above to justify one or more binomial models. Compute the average direct causal effect of gender, weighting each discipline in proportion to the number of
applications in the sample. Refer to the marginal effect example in Lecture 9 for help.

#### Question 3: Considering the total effect (problem 1) and direct effect (problem 2) of gender, what causes contribute to the average difference between women and men in award rate in this sample? It is not necessary to say whether or not there is evidence of discrimination or the presence or absence of unobserved confounds (which are likely!). Simply explain how the direct effects you have estimated make sense (or not) of the total effect.

#### Question 4: The data in data(UFClefties) are the outcomes of 205 Ultimate Fighting Championship (UFC) matches (see ?UFClefties for details). It is widely believed that left-handed fighters (aka “Southpaws”) have an advantage against right-handed fighters, and left-handed men are indeed over-represented among fighters (and fencers and tennis players) compared to the general population. Estimate the average advantage, if any, that a left-handed fighter has against right-handed fighters. Based upon your estimate, why do you think left-handers are over-represented among UFC fighters?
